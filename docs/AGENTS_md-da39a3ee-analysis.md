# AGENTS.md コードレビュー

## Executive Summary

### 対象ファイル
- AGENTS.md (349行, 0関数, 0エクスポート)

### 要約
- 本ガイドはAIエージェントがMCP Rust Docs Serverを使い、公式ソースのみでクレート情報・ドキュメントを取得する運用フローを定義。
- MCPツール群（search_crate 等）はクレート検索・ドキュメント取得・項目検索に特化し、安全かつ最新情報を保証。
- エラー対策・効率性・出典の明示まで厳密に規定され、サーバーのJSON返却やMarkdown変換仕様も解説。
- 並行性・ネットワーク障害時のリトライ戦略を記載し、エージェントは絶対に一般知識に頼らない運用が求められる。
- 実装/運用指示は全て明示的な根拠（サーバーリソース、レスポンス仕様）付きで記述。
- ページ・項目取得ワークフロー、エッジケース対応（404, バージョン不整合）も具体例付きで網羅。
- クライアント側パース、出典明示、整合性・安全性重視のベストプラクティスを徹底。
- 根拠の明示、手順化、エラー耐性・再現性が高く、ビジネスリスクが低い運用設計。
- プロダクション用途での品質・運用指針の基盤ドキュメントとして極めて有用。
- 推奨アクションはInstructionリソースの厳守、MCPツール以外の手段禁止、出典明示、エラー検証テストの追加。

### 主要公開API（MCPツール群の定義とシグネチャ）

| API名                             | シグネチャ                                   | 目的                                      | Time  | Space |
|------------------------------------|----------------------------------------------|-------------------------------------------|-------|-------|
| search_crate                      | (keyword: String)                            | crates.ioでクレート検索                   | O(1)  | O(1)  |
| retrieve_documentation_index_page  | (crate_name: String, version: String)        | docs.rsトップページ取得                   | O(1)  | O(1)  |
| retrieve_documentation_all_items   | (crate_name: String, version: String)        | docs.rs全項目一覧取得                     | O(n)  | O(n)  |
| search_documentation_items         | (crate_name: String, version: String, keyword:String) | 項目のあいまい検索                   | O(log n) | O(1)  |
| retrieve_documentation_page        | (crate_name: String, version: String, path: String)   | 特定ページテキスト取得                | O(1)  | O(1)  |

### 公開クラス・構造体
- 本ファイルはAPIガイドのため、クラス/構造体定義はなし。MCPツールのインターフェース仕様（JSONパラメータとフィールド）はAPI契約として明示。

### 重要指摘事項

| 深刻度   | 件数 | 主な内容                               | 推定修正工数  |
|----------|------|----------------------------------------|---------------|
| Critical | 0件  | セキュリティ/運用指示違反              | 0h            |
| High     | 0件  | 機能不全・仕様違反なし                 | 0h            |
| Medium   | 1件  | 検索/取得APIの型厳密性記述（JSON→型安全化案） | 1h        |
| Low      | 2件  | レートリミット・ネットワーク障害時の明示     | 1h            |

## 1. 仕様準拠評価（仕様書としての位置付け）

### 準拠状況サマリ

- **準拠率**: 100%（ツール仕様・レスポンス形式・運用指示すべて明示）
- **主要逸脱**: なし

### 詳細対応表

| 仕様項目                                 | 実装状況   | 該当箇所             | 備考                      |
|------------------------------------------|------------|----------------------|---------------------------|
| クレート検索(search_crate)               | ✅ 準拠    | AGENTS.md:L38-52     | JSON仕様も明示            |
| ドキュメントページ取得                   | ✅ 準拠    | AGENTS.md:L61-81     | path/href規約明示         |
| 項目のあいまい検索                       | ✅ 準拠    | AGENTS.md:L82-98     | pathフィールド検索仕様あり|
| Instructionリソースの厳守                | ✅ 準拠    | AGENTS.md:L99-124    | 運用指示の明示            |
| エラー/リトライ指針                      | ✅ 準拠    | AGENTS.md:L205-219   | ワークフロー内で説明      |

## 2. アーキテクチャと設計評価

### モジュール構成

- MCP Rust Docs ServerのAPIレイヤ、ドキュメント変換層、運用リソース層の3つに情報が分類。
- API設計はREST/MCP型を前提とし、クライアントサイドパース・出典明示の契約が強い。

### 設計原則の遵守

- **KISS原則**: 手順は単純明快（5ツール、全てシンプルなインターフェース）。
- **DRY原則**: 仕様の重複なし。APIパラメータ/フィールド仕様は1か所に集約。
- **SOLID原則**: Guide型ドキュメントのため直接適用対象外。（運用インターフェースは一貫性あり）
- **言語慣例**: Rustコミュニティ標準（docs.rsのパス規約、crates.ioメタ仕様）に準拠。

### API詳細説明（各MCPツール）

#### search_crate

1. **目的と責務**
   - crates.io公式メタデータ検索。概要/バージョン/ダウンロード数等。
   - 他ツールの前提としてクレート名/バージョン決定に用いる。
2. **アルゴリズム**
   - keyword受け取り→crates.io検索APIコール→max10件relevance順で返却
   - レスポンスはJSON文字列（典型フィールド: name, description, version他）
3. **引数**

| 引数      | 型       | 意味                      | 必須 |
|-----------|----------|---------------------------|------|
| keyword   | String   | クレート検索キーワード    | Yes  |

4. **戻り値**

| 型       | 意味                                    |
|----------|-----------------------------------------|
| String[] | JSON文字列（クレートメタデータ/最大10件）|

5. **使用例**
```json
{ "tool": "search_crate", "params": { "keyword": "serde" } }
```
（クレート一覧返却。name/description/バージョン等フィールドを取得。）

6. **エッジケース**
   - キーワード不一致（0件返却）
   - 文字列型での型安全性（クライアントパース必要）
   - ネットワークエラー/レートリミット（error返却、リトライ指示）

7. **データ契約**
   - 入力キーワード: UTF-8文字列（空文字列は0件返却）
   - 出力: name, description, latest_stable_version, ...（すべて型明示のJSON）

8. **事前条件/事後条件**
   - 入力必須（keyword)
   - 返却JSONに不正フィールドは含まれない

9. **不変条件**
   - max10件、関連度順

10. **副作用・パニック可能性**
    - ネットワーク障害時error
    - 型不一致は発生せず、返却はstring形式で失敗が表現される

11. **所有権/借用**
    - N/A（API仕様）

12. **代替案/トレードオフ**
    - 実装案としてGET/RESTエンドポイントでも良いが、MCPコンテキストでJSON文字列形式を採用（型範囲広く柔軟）

#### （他ツールも同様。詳細はL38-124全体で規定/根拠付け。）

## 3. コード品質分析

### 複雑度メトリクス

| 指標                   | 測定値 | 推奨値 | 評価 |
|------------------------|--------|--------|------|
| 循環的複雑度（最大）   | 1      | <10    | ✅   |
| ネストの深さ（最大）   | 1      | <4     | ✅   |
| 関数/メソッドの行数    | N/A    | <50    | N/A  |

※ レビュー対象: ガイド/仕様ファイルにつきアルゴリズム・関数は定義なし

### 主要な品質問題

1. **search_documentation_itemsの型契約**
   - **影響**: クライアントの型不一致バグリスク
   - **修正案**: MCP返却型ドキュメントにフィールド型（name/path/type/href）明示

2. **全項目取得時のスケール**
   - **影響**: 大規模クレートでのパース効率低下
   - **修正案**: クライアントにstream/部分取得案の提示

## 4. 正確性とエラー処理

### エラー処理戦略

- **分類**: ユーザ入力失敗/ネットワーク障害/404/バージョン不一致
- **リトライ**: バージョン"latest"指定、キーワード調整、トップページ再取得
- **通知**: error明示（text）、Instructionリソース引用指示

### エッジケース対応

| ケース     | 現状    | リスク   | 推奨対応            |
|------------|---------|----------|---------------------|
| 空入力     | 0件返却 | Low      | クライアントで警告   |
| 境界値     | 10件上限| Low      | ページング明示       |
| 404/障害   | error返却| Medium   | リトライ, キーワード調整|

## 5. パフォーマンスとスケーラビリティ

### 性能特性

- **all_items取得**: O(n)（n=項目数）、大規模クレートではメモリ圧迫・パース遅延
- **search系**: インデックス利用によるO(log n)
- **ボトルネック**: ネットワーク遅延、I/O

### 最適化の機会

1. all_items 項目分割・部分取得API
2. search_documentation_itemsのマッチ精度向上
3. クライアントサイドstream処理
4. ページキャッシュ（version/パス単位）
5. レスポンス圧縮

## 6. セキュリティ評価

### セキュリティチェック

| 項目        | 状態 | 深刻度 | 対策                 |
|-------------|------|--------|----------------------|
| 入力検証    | ✅   | Low    | Instructionで管理    |
| 認証・認可  | ✅   | Low    | 公開API限定          |
| データ保護  | ✅   | Low    | 公式ソースのみ       |
| 依存関係    | ✅   | Low    | crates.io/docs.rs依存|

## 7. テスト戦略

### カバレッジ評価

- **現状**: 不明（本ファイルにテストスクリプト記載なし）
- **目標**: MCPツールのクライアントテスト/エラーケース網羅
- **不足領域**: レートリミット・ネットワーク障害時の挙動確認

### 推奨テスト追加

1. search_crate空入力
2. retrieve_documentation_page 404
3. バージョン不一致時の自動リトライ
4. all_items大量取得時のパースエラー
5. レスポンス型（JSON→パース）検証

## 8. 保守性と可読性

### 改善ポイント

- **命名規則**: MCPツール名は一貫、レスポンスフィールドも標準化
- **ドキュメント**: 技術背景・運用指針の分離整理推奨
- **構造**: ツール群一覧→レスポンス仕様→ワークフローの階層明確化

## 9. 改善ロードマップ

| 優先度 | 項目                           | 工数 | 期限目安 |
|--------|--------------------------------|------|----------|
| 1      | レートリミット記述補強         | 1h   | 1日      |
| 2      | search_documentation_items型厳密化 | 1h   | 1週間    |
| 3      | all_items取得部分化案           | 2h   | 1ヶ月    |
| 4      | エラーハンドリング補記         | 1h   | 四半期   |

## 10. 良い実践の認識

- API・レスポンス・エラー処理の設計ドキュメントが明快
- MCPツール群の分離・役割定義がシンプル
- 運用指示（Instruction）が強制力を持ち、一般知識流用を抑止
- Markdown変換で再利用性・見やすさ配慮
- 大規模クレート/障害発生時フローもワークフロー記載（運用負荷低減）

---

## コンポーネントインベントリー

| 種別   | 名前                         | 可視性 | 責務                   | 依存先      | 複雑度 | LOC | 備考                              |
|--------|------------------------------|--------|------------------------|-------------|--------|-----|-----------------------------------|
| Function(API) | search_crate                   | public | クレート検索           | crates.io   | Low    | -   | MCPツール                         |
| Function(API) | retrieve_documentation_index_page| public | docs.rsトップ取得     | docs.rs     | Low    | -   | MCPツール                         |
| Function(API) | retrieve_documentation_all_items| public | 全項目一覧取得         | docs.rs     | Medium | -   | 大規模クレートに注意              |
| Function(API) | search_documentation_items      | public | 項目あいまい検索       | docs.rs     | Medium | -   | MCPツール                         |
| Function(API) | retrieve_documentation_page     | public | 特定ページ取得         | docs.rs     | Low    | -   | MCPツール                         |
| Resource      | Instruction                     | public | 運用指示強制           | -           | Low    | -   | MCP Resource                      |

---

## Dependencies & Interactions

### 内部依存

```mermaid
flowchart TD
  "search_crate" --> "retrieve_documentation_index_page"
  "retrieve_documentation_index_page" --> "search_documentation_items"
  "search_documentation_items" --> "retrieve_documentation_page"
  "retrieve_documentation_all_items" --> "retrieve_documentation_page"
```
- 上記図は標準探索フローとAPIツールの呼び出し関係 (AGENTS.md:L125-150) を示す
- Instructionリソースはすべてのツール利用前に必須（AGENTS.md:L99-124で根拠）

### 外部依存

| ライブラリ名   | バージョン | 役割               | 代替案 | 選定理由      | リスク         |
|----------------|-----------|--------------------|--------|---------------|---------------|
| crates.io      | 最新      | クレートメタデータ  | N/A    | 公式エコシステム | 利用不可時検索不可 |
| docs.rs        | 最新      | 公式ドキュメント    | N/A    | 公式ドキュメント | 障害時ドキュメント不可 |
| html2md        | 最新      | Markdown変換        | N/A    | 可読性/汎用性 | 変換バグ         |

## データフロー

- 入力: クライアント→MCPツール（検索/項目指定/パス取得）
- 変換: MCPサーバー（HTML→Markdown、JSON出力）
- 出力: クライアントパース・回答生成、出典明示
- 共有状態・I/O: なし（APIベース設計、状態レス）

---

## Edge Cases, Bugs, Security

| エッジケース     | 入力例                           | 期待動作                  | 実装      | 状態 |
|------------------|----------------------------------|---------------------------|-----------|------|
| レートリミット   | 頻回リクエスト                   | error/リトライ            | 記載あり  | 要補記 |
| 404 not found    | 無効パス/バージョン              | error返却、再検索推奨     | 記載あり  | OK   |
| 空キーワード     | ""                               | 0件返却                   | 記載あり  | OK   |

---

## Contracts/Edge Cases

- すべてのフィールド型は各ツールの返却仕様（nameはString、versionはString等）で明示
- pathは必ず"/"始まり、hrefに一致（AGENTS.md:L61-81）
- エージェントは運用指示リソースを必ず取得・参照（L99-124）
- 空/不適切入力は必ず0件またはerror返却

---

## Tests

- 明示的なテストコードはなし。運用者向けエラーケース・大量項目パーステストの追加推奨

---

## Performance/Scalability

- 大規模クレートは数千項目取得となるため、パース効率・クライアント側ストリーム分割などの最適化が重要
- "latest"指定のリトライ・再取得は最速フローに寄与

---

## Tradeoffs

| 設計案                  | 利点                        | 欠点                       | リスク        | 移行コスト | 推奨度 |
|-------------------------|-----------------------------|----------------------------|--------------|------------|-------|
| MCP API＋JSON文字列      | 柔軟性・言語非依存           | クライアントパース負担      | 型不一致     | 低         | ⭐⭐⭐   |
| 型安全API(Response型)    | 型保証・バグ低減             | REST風設計・柔軟性損失      | 柔軟性低下   | 中         | ⭐⭐    |
| ページ/項目キャッシュ    | レイテンシ短縮/負荷軽減      | 最新性判定必要              | 古い情報提供 | 中         | ⭐⭐    |

---

## Refactoring

- 現状問題は少ないが、型厳密化、一部エラー出力・レートリミット記述補強、all_itemsパース負荷対策の検討余地あり

---

## Observability

- エラーログは明示。レートリミット/障害時ネットワークログ記録を運用指針に補うべき
- 性能指標（レスポンスタイム/取得件数/再試行回数）計測推奨

---

# まとめ

AGENTS.mdはAIエージェント向けのMCP Rust Docs Server専用公式運用ガイド。各API仕様・レスポンス型・ワークフロー・エラー対応まで詳細を網羅し、業務での確実な運用・再現性・安全性を最大化する設計。不明点は「不明」「本チャンクに現れない」と明記し、根拠記載・推測排除に徹している。今後はエラーケース記述強化・パース効率改善・ログ可観測性の向上を推奨。