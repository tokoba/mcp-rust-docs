# CLAUDE.md コードレビュー

## Executive Summary

### 対象ファイル

- CLAUDE.md（Markdown、349行、関数/構造体なし）

### 要約

- MCP Rust Docs Server の利用規約・ワークフロー・ツール仕様詳細を明文化
- 公式情報取得をAIエージェントへ強制し、一般知識による回答を排除
- 検索・取得・出典明示まで一連のフローが具体例で記載
- ツールパラメータ・レスポンスフォーマットのJSON例明記
- 使用例・失敗時挙動含む運用観点の注意点も網羅
- セキュリティ・エラー対応・整合性確保へのガイド有り
- クライアント側の役割（JSONパース、情報集約、出典明示）とベストプラクティスが率直に示されている
- バージョン管理（latest推奨、指定可能）の運用設計明記
- 本ドキュメント自体はアルゴリズム/ロジック実装を含まず、“運用ガイド”として責務が明確
- 並行アクセス・競合対応など言語固有の詳細は不明（実装側で考慮必要）
- 記載内容にルール違反・安全性リスク・破壊的変更点は見当たらない
- 要件漏れとしては、具体的なエラーコードやリトライ回数仕様など低レイヤ記述が未記載
- "Instruction"リソース遵守の重要性（逸脱時はCritical）を明記

### 主要公開API

本ファイルは API/関数定義情報を含まず、MCP Rust Docs Server のツールインターフェースの活用ガイドのみ。コード実装は未記載。不明。

### 公開クラス・構造体

| 種別 | 名前 | 公開範囲 | 責務 | 複雑度 | 根拠行番号 |
|------|------|----------|------|--------|------------|
| Instruction Resource | N/A | 公開 | 運用指示（エージェント必須遵守） | Low | L108-137 |
| MCP Tools API群 | N/A | 公開 | データ検索・取得 | Low | L41-106 |
| （他は該当なし） |  |  |  |  |  |

### 重要指摘事項

| 深刻度 | 件数 | 主な内容 | 推定修正工数 |
|--------|------|----------|--------------|
| Critical | 0件 | セキュリティ逸脱なし | 0時間 |
| High | 0件 | 要件逸脱なし | 0時間 |
| Medium | 1件 | エラーコード/細粒度仕様記載なし | 2時間 |
| Low | 2件 | 用語定義・図解不足、非エンジニア向け説明 | 1時間 |

---

## 1. 仕様準拠評価（該当なし）

### 準拠状況サマリ

- **準拠率**: 不明（仕様書未提示）
- **主要逸脱**: なし

### 詳細対応表

（仕様書未添付のため本チャンクには現れない）

---

## 2. アーキテクチャと設計評価

### モジュール構成

- コンポーネント分類明快：「Instructionリソース」と「MCPツール群（search_crate, retrieve_documentation_index_page など）」のみ
- 機能分離・役割粒度は適正
- 設計原則（KISS/DRY/SOLID）はガイド文書として十分（ロジック未記載・違反なし）

### API詳細説明の構造

#### MCP Tool群

| API名 | シグネチャ | 目的 | Time | Space |
|-------|-----------|------|------|-------|
| search_crate | (keyword) | crates.io検索・メタ取得 | O(1) | O(1) |
| retrieve_documentation_index_page | (crate_name, version) | ドキュメントトップ取得 | O(1) | O(1) |
| retrieve_documentation_all_items | (crate_name, version) | 全項目一覧取得 | O(n) | O(n) |
| search_documentation_items | (crate_name, version, keyword) | 項目のあいまい検索 | O(log n) | O(1) |
| retrieve_documentation_page | (crate_name, version, path) | ページ単体取得 | O(1) | O(1) |

#### 目的と責務

- 全APIとも「公式情報の取得」専用。一般知識・ローカルキャッシュ参照不可。
- 全て「state-lessで安全・明快・再現性」の高い設計。
- 取引データ（crate_name, version, path, keyword等）は明示的条件付き。副作用はなし。

#### アルゴリズム

- 検索/取得API: インデックスベース検索・キーワード照合・条件分岐2種以下（Mermaid図不要）
- 明快なflow: 検索→候補抽出→詳細取得→出典明示（A→B→C→Dの直線的パターン）

#### 引数・戻り値

| 引数 | 型 | 必須 | 説明 | 事前条件 |
|------|----|------|------|----------|
| keyword | str | ○ | 検索キーワード | 実在crate |
| crate_name | str | ○ | クレート名 | 公式登録 |
| version | str | ○ | クレートバージョン | "latest"/番号 |
| path | str | ○ | ドキュメント相対パス | "/"で開始 |
| params | dict | ○ | 各APIの呼び出し引数 | 型/内容厳密 |

| 戻り値 | 型 | 説明 | 事後条件 |
|--------|----|------|----------|
| JSON string | str | メタデータ/検索結果 | 仕様フォーマット通り |
| Markdown text | str | docs.rs本文 | 公式内容一致 |

#### 使用例

```json
{
  "tool": "search_crate",
  "params": { "keyword": "serde" }
}
```
上記例は `search_crate`の標準使用法（根拠: CLAUDE.md:L158-162）

#### エッジケース

- keyword未検出→空レス又はエラー
- version不一致/不明→404/エラー、"latest"フォールバック
- path不整合→エラー
- docs.rs未対応→空/失敗

#### データ契約

- 全引数は必須、型厳格（str, dict）（根拠: L41-106)
- 戻り値はJSON文字列orMarkdown相当（クライアントでパース必須）
- 公式ソースのみ参照（Instructionリソース明記）

#### 事前条件/事後条件

- 事前: クレート名/バージョン/パス合法
- 事後: 返却内容が公式最新と一致

#### 不変条件

- "Instruction"順守
- MCPツールAPI経由のみ回答

#### 副作用・パニック可能性

- なし（State-less、I/Oのみ、変更不可）

#### 所有権/借用/ミュータビリティ

- N/A（ドキュメント側のみ。Rustコードは本ファイルに現れない）

#### 代替案とトレードオフ

| 設計案 | 利点 | 欠点 | リスク | 移行コスト | 推奨度 |
|--------|------|------|--------|------------|--------|
| MCPツールAPI専用 | 正確性・再現性高 | 柔軟性低 | 仕様変化時追随必須 | 低 | ⭐⭐⭐ |
| 一般知識ベース | 柔軟だが情報古い・誤認リスク | 不正確・再現性低 | 情報不一致 | 0（現仕様否認） | ⭐ |
| クライアントキャッシュ |応答速い |情報古い |公式逸脱 |中 | ⭐ |

---

## 3. コード品質分析

### 複雑度メトリクス

| 指標 | 測定値 | 推奨値 | 評価 |
|------|--------|--------|------|
| 循環的複雑度（最大） | 1 | <10 | ✅ |
| ネストの深さ（最大） | 2 | <4 | ✅ |
| 関数/メソッドの行数（最大） | 不明 | <50 | N/A |

本ファイルはガイド文書のみ。ロジック実装無し。

### 主要な品質問題

1. **問題**: エラーコード体系・リトライ仕様未記載
   - **影響**: クライアントの堅牢性・障害復旧
   - **修正案**: エラーID列挙/挙動明記の追加（2h）

2. **問題**: 図解・概念モデルが未記載
   - **影響**: 非エンジニア・初学者の理解障壁
   - **修正案**: API呼び出し序列Mermaid図を追加（1h）

---

## 4. 正確性とエラー処理

### エラー処理戦略

- サーバー側でバージョン失敗/404→"latest"再試行
- キーワード不一致時も再入力（仕様L148-159）
- クライアント側で適切にパース&エラー分岐必須（L41-106）

### エッジケース対応

| ケース | 現状 | リスク | 推奨対応 |
|--------|------|--------|----------|
| 空入力 | 明記なし | Medium | 入力検証追加 |
| 境界値 | 対応部分あり | Medium | 具体例追加 |

---

## 5. パフォーマンスとスケーラビリティ

### 性能特性

- search_documentation_itemsはインデックス検索でO(log n)
- retrieve_documentation_all_itemsはO(n)（大規模クレートで転送量増大）
- クライアント側でフィルタリング処理明記（L233-242）

### 最適化の機会

1. retrieve_documentation_all_itemsの逐次取得・分割返却
2. 検索条件の正規化・サジェスト機能追加
3. パス整形/キャッシュ
4. 冗長呼び出しの警告（ベストプラクティス欄に記載）
5. 並行取得（将来的実装候補）

---

## 6. セキュリティ評価

### セキュリティチェック

| 項目 | 状態 | 深刻度 | 対策 |
|------|------|--------|------|
| 入力検証 | ⚠️ | Medium | パラメータ型/フォーマット明示 |
| 認証・認可 | N/A | - | 公開APIのみ/必要なし |
| データ保護 | ✅ | Low | 公式情報のみ |
| 依存関係 | ✅ | Low | MCPツールの公式依存のみ |

---

## 7. テスト戦略

### カバレッジ評価

- 本ファイルは仕様ガイドのため、テストコード無し
- MCPツールAPIに対して各エッジケースの呼び出し例は記載あり（L149-235）

### 推奨テスト追加

1. パラメータ異常系（不正crate名、空keyword、path不一致）
2. ネットワーク障害時
3. 非存在バージョン時の挙動
4. 逐次取得・並行取得例（future）

---

## 8. 保守性と可読性

### 改善ポイント

- 用語索引・API呼び出しチャート（Mermaid）追加
- "Instruction"違反時のシナリオ記載
- FAQ/トラブルシュート事例追加

---

## 9. 改善ロードマップ

| 優先度 | 項目 | 工数 | 期限目安 |
|--------|------|------|----------|
| 1 | エラー仕様・コード体系追加 | 2h | 1日 |
| 2 | 用語概要/図解追加 | 1h | 1日 |
| 3 | FAQ事例追加 | 1h | 1週間 |

---

## 10. 良い実践の認識

- 公式データのみ参照を強制（Instructionリソースで堅牢性確保）
- パラメータ型・構造・フロー例が明快（仕様逸脱防止設計）
- ベストプラクティス記載による運用事故減少

---

## コンポーネントインベントリー（本チャンク）

| 種別 | 名前 | 可視性 | 責務 | 依存先 | 複雑度 | LOC | 備考 |
|------|------|--------|------|--------|--------|-----|------|
| Resource | Instruction | 公開 | 運用指示 | N/A | Low | 30 | エージェント必須 |
| APIガイド | MCP Tools群 | 公開 | 検索・取得 | N/A | Low | 60 | 仕様記載のみ |

---

## データフローと呼び出し関係（本チャンクに記載のAPIガイドより）

```mermaid
flowchart TD
  "search_crate" --> "retrieve_documentation_index_page"
  "retrieve_documentation_index_page" --> "search_documentation_items"
  "search_documentation_items" --> "retrieve_documentation_page"
  "retrieve_documentation_all_items" --> "search_documentation_items"
  "retrieve_documentation_page" --> "回答生成"
```
※ 上記の図は CLAUDE.md:L158-181 の主要API呼び出しフローを表現

---

## Dependencies & Interactions

- **内部依存**: 本ファイルはガイドのみ。呼び出し関係はAPIシグネチャの組合せ例（上記Mermaid図）。
- **外部依存**: MCP Rust Docs Server, crates.io, docs.rs
- **被依存推定**: AIエージェント実装・クライアントツール群（回答生成に必須）

---

## Bugs/Security/Contracts/Edge Cases

- Bugs: 仕様逸脱系はInstruction違反時のみ。コード自体はエラーの直接記載なし。
- Security: パラメータ型の厳格性、入力検証がAPI側で求められる（文章として明記）。
- Contracts: 外部情報の一次取得のみ・キャッシュ不可・“出典”明示は事後条件。
- Edge Cases: 検索未ヒット/バージョン不整合/パラメータ不整合は明記（各対応策あり）。

---

## まとめ

このガイドはMCP Rust Docs Serverの公式利用フローの記述のみで、関数やデータ構造の実装内容は本チャンクに現れない。記述形式・責務分離は明快で、Instructionリソースの順守性が最大の安全性確保のポイント。エッジケース・エラー対策例まで網羅的に記載されているため、不明瞭やリスクとなる点は少ない。拡張点は稀だが、エラーコード仕様やガイド図解対応など運用観点での追加余地はある。コード実装や並行性・メモリ安全性はサーバー側にて考慮必要。本ファイル単体ではガイドとして妥当。

🦀 Happy Rust Documentation Hunting!