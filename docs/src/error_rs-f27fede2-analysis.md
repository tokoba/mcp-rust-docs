# src/error.rs コードレビュー

## コンポーネントインベントリー

| 種別   | 名前                                                                | 公開範囲 | 責務                                    | 依存先                         | 複雑度 | LOC | 備考                             |
|--------|---------------------------------------------------------------------|----------|-----------------------------------------|--------------------------------|--------|-----|----------------------------------|
| Enum   | Error                                                              | pub      | アプリケーションエラーの集約・表現       | thiserror, tantivy, rmcp       | Low    | 25  | 構造が単純だが外部変換含む       |
| Impl   | Into<rmcp::ErrorData> for Error                                    | pub      | Error→ErrorData の変換                  | Error, rmcp                    | Low    | 7   | カスタムエラーフォーマット定義    |

## Executive Summary

### 対象ファイル
- src/error.rs (28行, 1関数・1型)

### 要約
- エラーハンドリングの集約型`Error`（enum）と外部システム`rmcp`とのインターフェース変換（Into実装）により、エラー管理の一元化を実現。tantivy、thiserrorといった堅牢な外部クレートへの依存があるが、可読性・保守性は高い。独自エラー文字列とメッセージを外部システムへ渡す設計は、ビジネスロジックから通信層まで一貫したエラーフローを実現する。セキュリティ・健全性・メモリ安全性もRust標準に極めて準拠。今後のエラー型追加にも柔軟に対応可能な構造。重大なセキュリティリスクは現状なし。

### 主要公開API

- pub enum Error
  - アプリケーション全体のエラー表現
- impl Into<rmcp::ErrorData> for Error
  - Error型→外部APIエラー型への変換

### 公開クラス・構造体

| 名前    | 種別 | 公開範囲 | 説明                       |
|---------|------|----------|----------------------------|
| Error   | enum | pub      | アプリケーションの全エラーを一元集約 |
| Into<rmcp::ErrorData> for Error | impl | pub | 外部サービス用へエラーを変換 |

### 重要指摘事項

| 深刻度    | 件数 | 主な内容                          | 推定修正工数 |
|-----------|------|-----------------------------------|--------------|
| Critical  | 0    | -                                 | 0h           |
| High      | 0    | -                                 | 0h           |
| Medium    | 1    | 新規エラー追加時の変換ロジック不足 | 0.5h         |
| Low       | 2    | Variant名の抽象度・メッセージ粒度 | 0.5h         |

---

## 1. 仕様準拠評価（不明）

### 準拠状況サマリ

- **準拠率**: 不明（仕様書がこのチャンクには現れないため判定不能）
- **主要逸脱**: 不明

### 詳細対応表

| 仕様項目 | 実装状況 | 該当箇所           | 備考      |
|----------|----------|--------------------|-----------|
| 要件#1   | 不明     | このチャンクには現れない | -         |

---

## 2. アーキテクチャと設計評価

### モジュール構成

- **Error(enum)**がアプリ全体のエラーを一元管理
- 各エラーvariantはユーザー表示&外部システムへの伝播の両立を意図
- 外部クレートへの依存最小
- `impl Into<rmcp::ErrorData>`で、外部API互換のエラーフォーマット変換を直接担当

#### 設計原則

- **KISS**: 各エラーは短く単純明快
- **DRY**: エラー型の重複なし
- **SOLID**: 単一責任（Error型が責務集中）、拡張性高
- **Rust慣例**: thiserror利用によりDisplay/Debugが一貫

### API Surface（公開API）一覧

| API名                 | シグネチャ                           | 目的                                     | Time | Space |
|----------------------|--------------------------------------|------------------------------------------|------|-------|
| Error                | pub enum Error {...}                 | アプリ全体で発生し得るエラー型の管理      | O(1) | O(1)  |
| Into<rmcp::ErrorData>| fn into(self) -> rmcp::ErrorData     | 外部インタフェース用エラーへの変換        | O(1) | O(1)  |

---

## 関数詳細テンプレート

### 1. Error (enum定義)

| 項目                      | 内容                                                                                                                      |
|---------------------------|---------------------------------------------------------------------------------------------------------------------------|
| シグネチャ                | `pub enum Error`                                                                                                          |
| 可視性                    | pub                                                                                                                       |
| 型パラメータ/制約         | なし                                                                                                                      |
| ミュータビリティ           | 不変（追加/除去は再コンパイル必要）                                                                                        |
| 所有権/参照の変化         | 値型、Moveセマンティクス                                                                                                   |
| 入力引数                  | N/A                                                                                                                       |
| 戻り値                    | N/A                                                                                                                       |
| 事前条件                  | N/A                                                                                                                       |
| 事後条件                  | N/A                                                                                                                       |
| 不変条件                  | 全variantはDisplay/Debugが定義                                                                                             |
| 副作用                    | なし                                                                                                                      |
| パニック/例外             | なし                                                                                                                      |
| エラーモデル              | 各variantで状況を表現、文字列/外部エラー型対応                                                                            |
| 計算量                    | O(1)                                                                                                                      |
| 並行性/スレッド安全性      | Send+Sync（外部型tantivyがSend+Sync前提）                                                                                 |
| 安全でない操作            | なし                                                                                                                      |
| 呼び出し関係              | 各モジュール/HTTP/DB処理等で使用（推定）                                                                                  |
| 使用例                    | ```rust<br>Err(Error::InitializeClient("理由".to_string()))<br>```                                                        |
| エッジケース              | 未知のエラーは新variant追加必須、各variantが追加エラーシーンを網羅できるか                                                |
| 根拠行番号                | src/error.rs:L1-24                                                                                                        |

#### 使用例
```rust
fn example() -> Result<(), Error> {
    Err(Error::InitializeClient("原因説明".to_string()))
}
```
各エラーに具体的な理由/メッセージを記述し、非公開情報は含めない運用前提。

### 2. impl Into<rmcp::ErrorData> for Error

| 項目                      | 内容                                                                                                                          |
|---------------------------|-------------------------------------------------------------------------------------------------------------------------------|
| シグネチャ                | `impl Into<rmcp::ErrorData> for Error { fn into(self) -> rmcp::ErrorData }`                                                  |
| 可視性                    | pub                                                                                                                           |
| 型パラメータ/制約         | なし                                                                                                                          |
| ミュータビリティ           | なし                                                                                                                          |
| 所有権/参照の変化         | self消費（move）                                                                                                              |
| 入力引数                  | self（Error）                                                                                                                 |
| 戻り値                    | rmcp::ErrorData                                                                                                               |
| 事前条件                  | エラーが発生しError型で管理されていること                                                                                      |
| 事後条件                  | ErrorData生成・内容がto_string()に依存                                                                                         |
| 不変条件                  | エラー内容は常にError::to_string()と一致                                                                                       |
| 副作用                    | なし                                                                                                                          |
| パニック/例外             | なし                                                                                                                          |
| エラーモデル              | エラー理由をメッセージとしてシリアライズ                                                                                       |
| 計算量                    | O(1)                                                                                                                          |
| 並行性/スレッド安全性      | Send+Sync、I/O/共有リソース未使用                                                                                             |
| 安全でない操作            | なし                                                                                                                          |
| 呼び出し関係              | 外部API通信直前等で呼び出し（推定）                                                                                           |
| 使用例                    | ```rust<br>let err: Error = ...;<br>let external = err.into();<br>```                                                        |
| エッジケース              | 短絡的なto_string()依存でパース不可文字列もメッセージ化。ErrorCode(1)固定で汎用的なため、多様な分類には非対応                   |
| 根拠行番号                | src/error.rs:L26-32                                                                                                          |

#### 使用例
```rust
let err = Error::Http("timeout".to_string());
let ext_err: rmcp::ErrorData = err.into();
// ext_err.code == 1, ext_err.message/to_string()は "HTTP request error: timeout"
```
業務的にはrmcp::ErrorCode(1)固定が多発時、運用設計側で分類運用も必要。

---

## データフロー/呼び出し図

```mermaid
flowchart TD
    "App内部コード" -->|"エラー発生時"| "Error(enum)"
    "Error(enum)" -->|"Into::into"| "rmcp::ErrorData"
    "rmcp::ErrorData" -->|"APIレスポンス等"| "外部システム/クライアント"
```
（上記の図は`impl Into<rmcp::ErrorData> for Error (L26-32)`の主要エラーフローを示す）

---

## Bugs/Security/Edge Cases

### Bugs/Security

- **バッファオーバーフロー/Use-after-free**: なし（Rust型安全）
- **インジェクション**: 文字列のみ、現状リスク低
- **秘密情報の漏洩**: `Error::to_string()`へ直接投入した文字列がそのままAPI経由で外部漏洩の恐れ→業務設計で要注意
- **並行性障害**: なし

### Edge Cases

| エッジケース          | 入力例                           | 期待動作                                            | 実装                      | 状態         |
|----------------------|----------------------------------|-----------------------------------------------------|---------------------------|--------------|
| 空文字列             | Error::Http("".to_string())      | "HTTP request error: " とだけ表示                   | to_string該当              | OK           |
| 非ASCII文字列        | Error::InitializeClient("あ")     | 正常にエラー表示                                    | Rust Unicode準拠           | OK           |
| tantivyエラー伝播    | tantivy::error::TantivyError     | From traitで自動Variant割当                         | #[from]にて                | OK           |
| ErrorCode拡張        | ErrorCode(1)以外不可             | 多様な分類不可、運用設計で判定                      | 固定値                     | 要検討       |

---

## Dependencies & Interactions

### 内部依存

- Error型はアプリ全域で利用される共通型（他モジュールからimportされて使われる前提）
- `Into<rmcp::ErrorData>`はAPI層orRPC層、外部システム通信境界前で使われる想定

### 外部依存

| ライブラリ名   | バージョン | 役割                   | 代替案        | 選定理由                   | リスク |
|----------------|------------|------------------------|---------------|----------------------------|--------|
| thiserror      | 1.x        | エラーデリベーション   | anyhow, snafu | 標準的、自動実装、堅牢     | 低     |
| tantivy        | 不明       | FTS関連エラー型        | -             | FTS用途なら適切             | 低     |
| rmcp           | 不明       | 外部エラー伝播型       | -             | API連携前提                 | 中     |

#### 被依存推定

- 本Error型はビジネスロジック、API層、永続化層、UI表現でも転用可能と推定され、多数モジュールから参照される設計

---

## 契約/Noted Contracts

- **to_string()**でメッセージ生成、運用上は出力内容の個人情報チェック要
- **ErrorCode(1)が固定**のため、将来用途拡張時はenumまたはMatchでVariantごと細分化推奨

---

## テスト・パフォーマンス・可観測性ポイント

- **テスト**: 単体テストで各VariantからErrorDataが期待どおり生成されることを検証すべき（仕様例はこのチャンクには現れない）
- **パフォーマンス**: 変換はO(1)、ヒープアロケーション量は文字列分以外は微小
- **可観測性**: Outputが全てto_string経由で記録されるため運用ログと連携しやすいが、情報量過多/不足時に粒度調整必要

---

## 改善ロードマップ

| 優先度 | 項目                   | 工数 | 期限目安 |
|--------|------------------------|------|----------|
| 1      | エラーEnum追加時の変換拡張 | 0.5h | 即日     |
| 2      | ErrorCode(1)分類拡張     | 1h   | 1週間    |
| 3      | Display文言の標準化      | 0.5h | 1ヶ月    |

---

## 良い実践の認識

- **thiserrorによる自動Display/Debug実装**で冗長なコードを削減しつつ安全性と拡張性両立（L1-L24）
- **外部依存との型変換（Into実装）**が単純明快で、API設計の一貫性が高い（L26-L32）
- **tantivy等外部エラー型の`#[from]`利用**で、第三者ライブラリとのブリッジも容易に維持できる設計（L18-L22）

---

**根拠行番号はsrc/error.rs:L1-32に基づく。機能追加や仕様変更時はmatch分岐でErrorCode等の粒度拡張が望ましい。**